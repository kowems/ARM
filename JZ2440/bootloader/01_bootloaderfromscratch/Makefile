#
# (c) Copyright 2015
# Eric Ju ,Eric.X.Ju@gmail.com
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License as
# published by the Free Software Foundatio; either version 2 of
# the License, or (at your option) any later version.


#				History
# 02/14/2015 Eric initial creation
#

VERSION = 1
PATCHLEVEL = 1
SUBLEVEL = 1
EXTRAVERSION =

U_BOOT_VERSION = $(VERSION).$(PATCHLEVEL).$(SUBLEVEL)$(EXTRAVERSION)
VERSION_FILE = $(obj)include/version_autogenerated.h

CC = arm-linux-gcc
LD = arm-linux-ld
AR = arm-linux-ar
OBJCOPY = arm-linux-objcopy
OBJDUMP = arm-linux-objdump

INCLUDEDIR := $(shell pwd)/include
CFLAGS := -Wall -O2 -nostdinc -I$(INCLUDEDIR)

target := boot

export CC LD AR OBJCOPY OBJDUMP INCLUDEDIR CFLAGS

objs := cpu/arm/start.o
libs := cpu/cpu.a drivers/driver.a lib_arm/lib_arm.a tools/tool.a

$(target).bin: $(objs) $(libs)
	${AR} -x cpu.a
	${AR} -x driver.a
	${AR} -x lib_arm.a
	${AR} -x tool.a
	${LD} -Tboot.lds -o $(target)_elf $(objs) *.o
	${OBJCOPY} -O binary -S $(target)_elf $@
	${OBJDUMP} -D -m arm $(target)_elf > $(target).dis

%.o:%.c
	$(CC) $(CFLAGS) -c -o $@ $<

.PHONY : cpu/cpu.a
cpu/cpu.a:
	cd cpu;make;mv cpu.a ..;cd ..

.PHONY : drivers/driver.a
drivers/driver.a:
	cd drivers;make;mv driver.a ..;cd ..

.PHONY : lib_arm/lib_arm.a
lib_arm/lib_arm.a:
	cd lib_arm;make;mv lib_arm.a ..;cd ..

.PHONY : tools/tool.a
tools/tool.a:
	cd tools;make;mv tool.a ..;cd ..

clean:
	cd cpu;make clean;
	cd drivers;make clean;
	cd lib_arm;make clean;
	cd tools;make clean;
	rm -f *.o *.a $(target).dis $(target).bin $(target)_elf
